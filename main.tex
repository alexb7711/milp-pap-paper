%%===============================================================================
% Document configuration

%%-------------------------------------------------------------------------------
% Document type
\documentclass[utf8]{FrontiersinHarvard}

%%-------------------------------------------------------------------------------
% Package configuration
\usepackage                                                                     % LaTeX Packages
{
    amsmath,                                                                    % Miscellaneous enhancements for mathematics
    amssymb,                                                                    % Math symbols
    booktabs,                                                                   % Extend tables
    cite,                                                                       % Improved citation mechanics
    graphicx,                                                                   % Enhance graphics
    lineno,                                                                     % Add line numbers to page
    microtype,                                                                  % Uses different techniques for spacing
    multicol,                                                                   % Create tables spanning multiple columns
    multirow,                                                                   % Create tables spanning multiple rows
    pgfplots,                                                                   % Plot in LaTeX
    subcaption,                                                                 % Subfigures (Get rid of this)
    subfloat,                                                                   % Subfigures
    tabularx,                                                                   % Add more contol to tables
    tikz,                                                                       % Generate figures in LaTeX
    xcolor,                                                                     % Colors
    xfp,                                                                        % No trailing zeros
}

%% Plot configurations
\usetikzlibrary{automata, positioning, arrows.meta}                             % Tikz macros
\pgfplotsset{compat=1.3, width=\textwidth}
\graphicspath{ {./fig/} }                                                       % Paths to find images

%% Paper configuration
\linenumbers                                                                    % Put line numbers
\setlength{\columnsep}{2cm}                                                     % Column separation
\let\cite\citep                                                                 % Redefine `\cite` as `\citep` because lazy

%%-------------------------------------------------------------------------------
% Custom Commands
\newcommand{\TODO}[1]{{\color{green} To do: #1}}                                % For adding notes to paper
\def\keyFont{\fontsize{8}{11}\helveticabold }

% Experiment information
%% Experiment parameters
\newcommand{\A}{26 }                                                            % Number of buses
\newcommand{\N}{250 }                                                           % Number of visits
\newcommand{\acharge}{0.9}                                                      % BOD charge percentage
\newcommand{\bcharge}{0.7 }                                                     % EOD charge percentage
\newcommand{\mincharge}{25\% }                                                  % Min visit charge percent
\newcommand{\maxcharge}{100\% }                                                 % Max visit charge percent
\newcommand{\batsize}{388 }                                                     % Battery capacity
\newcommand{\fast}{15 }                                                         % Number of fast chargers
\newcommand{\slow}{15 }                                                         % Number of slow chargers
\newcommand{\fasts}{911 }                                                       % Speed of fast charger
\newcommand{\slows}{30 }                                                        % Speed of slow charger

%% Solve output
\newcommand{\timeran}{10000 }                                                   % Time ran for MILP
\newcommand{\gurobisolvetime}{9999 }                                            % Time for optimal result
\newcommand{\processor}{Ryzen 9 }                                               % Processor type

%%-------------------------------------------------------------------------------
% Authors
\def\keyFont{\fontsize{8}{11}\helveticabold }
\def\firstAuthorLast{Brown {et~al.}} %use et al only if is more than 1 author
\def\Authors{Alexander Brown\,$^{1,*}$, Greg Droge\,$^{2}$}
% Affiliations should be keyed to the author's name with superscript numbers and be listed as follows: Laboratory,
% Institute, Department, Organization, City, State abbreviation (USA, Canada, Australia), and Country (without detailed
% address information such as city zip codes or street names). If one of the authors has a change of address, list the
% new address below the correspondence details using a superscript symbol and use the same symbol to indicate the author
% in the author list.
\def\Address{$^{1}$Department of Electrical and Computer Engineering, Logan, UT, USA \\
$^{2}$Department of Electrical and Computer Engineering, Logan, UT, USA}
% The Corresponding Author should be marked with an asterisk Provide the exact contact address (this time including
% street name and city zip code) and email of the corresponding author
\def\corrAuthor{Alexander Brown}
\def\corrEmail{A01704744@usu.edu}

\author[\firstAuthorLast ]{\Authors} %This field will be automatically populated
\address{} %This field will be automatically populated
\correspondance{} %This field will be automatically populated
\extraAuth{}

%%===============================================================================
% Title, Authors, Abstract, Keywords
\begin{document}
\onecolumn
\firstpage{1}

%%-------------------------------------------------------------------------------
% Title
\title{A Position Allocation Approach to the Scheduling of Battery Electric Bus Charging}

%%---------------------------------------------------------------------------------
% Create title
\maketitle

%%---------------------------------------------------------------------------------
% Abstract
\begin{abstract}
\TODO{revisit}Dependable charging schedules for an increasing interest of battery electric bus (BEB) fleets is a
critical component to a successful adoption. In this paper, a BEB charging scheduling framework that considers
spatiotemporal schedule constraints, route schedules, fast and slow charging, and battery charging dynamics is modeled
as a mixed integer linear program (MILP). The MILP is modeled after the berth allocation problem (BAP) in a modified
form known as the position allocation problem (PAP). Linear battery dynamics are included to model the charging and
discharging of buses while at the station and during their routes, respectively. The optimization coordinates BEB
charging to ensure each BEB has sufficient charge while using slow chargers where possible for sake of battery health.
The model also minimizes the total number of chargers utilized and prioritizes slow chargers. The model validity is
demonstrated with a randomly generated set of routes for \A buses and \N visits to the charging station. The results
show that the slow chargers are more readily selected and the charging and spatiotemporal constraints are met while
considering the battery dynamics.

\tiny \keyFont{ \section{Keywords:} Berth Allocation Problem (BAP), Position Allocation Problem (PAP), Mixed Integer
  Linear Program (MILP), Battery Electric Bus (BEB), Scheduling} %All article types: you may provide up to 8 keywords;
at least 5 are mandatory.
\end{abstract}

%%===============================================================================
% Paper

%%-------------------------------------------------------------------------------
% Introduction
\section{Introduction}
\label{sec:introduction}
The public transportation system is crucial in any urban area; however, the increased awareness and concern of
environmental impacts of petroleum based public transportation has driven an effort to reduce the pollutant footprint
\cite{DeFilippo2014, Xylia2018, Guida2017, Li2016}. Particularly, the electrification of public bus transportation via
battery power, i.e., battery electric buses (BEBs), has received significant attention \cite{Li2016}. Although the
technology provides benefits beyond reduction in emissions, such as lower driving costs, lower maintenance costs, and
reduced vehicle noise, battery powered systems introduce new challenges such as larger upfront costs, and potentially
several hours long ``refueling'' periods \cite{Xylia2018, Li2016}. Furthermore, the problem is exacerbated by the
constraints of the transit schedule to which the fleet must adhere, the limited amount of chargers available, and the
adverse affects in the health of the battery due to fast charging \cite{Lutsey2019}. This paper presents a continuous
scheduling framework for a BEB fleet that shares limited fast and slow chargers. This framework takes into consideration
linear charging dynamics and a fixed bus schedule while meeting a certain battery charge threshold throughout the day.

Many recent efforts have been made simultaneously solve the problems of scheduling and charging fleets and determining
the infrastructure upon which they rely, e.g., \cite{Wei2018, Sebastiani2016, Hoke2014, Wang2017}. The added complexity
of considering both the BEB charge scheduling and the infrastructure problems necessitates simplifications for sake of
computation of the charge scheduling problem. Further complexities are introduced in the form of schemes to introduce
BEBs into existing fleets by replacing existing buses \cite{Zhou2020-1, Rinaldi2020, Duan2021}, assigning BEBs to
routes, and introducing uncertainties into the models \cite{Tang2019, Duan2021}. These simplifications to the charge
scheduling model include utilizing only fast chargers while planning \cite{Wei2018, Sebastiani2016, Wang2017,
  Zhou2020-0, Liu2020, Yang2018, Wang2017a, Qin2016}. If slow chargers are used, they are only employed at the depot and
not the station \cite{He2020, Tang2019}. Some approaches assume full charge \cite{Wei2018, Wang2017, Zhou2020-0,
  Wang2017a}. Others have assumed that the charge received is proportional to the time spent on the charger
\cite{Liu2020, Yang2018}, which can be a valid assumption when the battery state-of-charge (SOC) is below 80\% charge
\cite{Liu2020}.

This work builds upon the Position Allocation Problem, a modification of the well studied Berth Allocation Problem
(BAP), as a means to schedule the charging of electric vehicles \cite{Qarebagh2019, Buhrkal2010, Frojan2015, Imai2001}.
The BAP is a continuous time model that solves the problem of allocating space for incoming vessels to be berthed. Each
arriving vessel requires both time and space to be serviced and is assigned a berthing location \cite{Imai2001}. Vessels
are lined up parallel to the berth to be serviced and are horizontally queued as shown in Fig \ref{subfig:bapexample}.
The PAP utilizes this notion of queuing for scheduling vehicles to be charged, as shown in Fig \ref{subfig:papexample}.
The PAP is formulated as a rectangle packing problem by assuming that vehicle charging will take a fixed amount of time,
the amount of vehicles that can charge is limited by the physical width of the vehicles, and each vehicle visits the
charger a single time \cite{Qarebagh2019}.

The main contribution of this work is the extension of the PAP novel approach to BEB charger scheduling. This includes
modeling and incorporation of a proportional charging model into the MILP framework, consideration of multiple charger
types, and inclusion of the route schedule for each bus. The result is a MILP formulation that coordinates charging
times and charger type for every visit that each bus makes to the station while considering a dynamic charge model and
scheduling constraints.

The remainder of the paper proceeds as follows: In Section \ref{sec:positionallocationproblem}, the PAP is introduced
with a formulation of the resulting MILP. Section \ref{sec:problemformulation} constructs the MILP for BEB scheduling,
including modifications to the PAP queuing constraints and development of a dynamic charging model. Section
\ref{sec:example} demonstrates an example of using the formulation to coordinate \A buses over \N total visits to the
  station. The paper ends in Section \ref{sec:conclusion} with concluding remarks.

%%-------------------------------------------------------------------------------
% The Position Allocation Problem
\section{The Position Allocation Problem}
\label{sec:positionallocationproblem}
The BEB charge schedule formulation in this work builds upon the PA, which, in turn, builds upon the BAP. This section
provides a brief overview of the BAP and a detailed formulation of PAP as presented in \cite{Qarebagh2019}.

\subsection{Overview of BAP}
The BAP is a rectangle packing problem where a set
of rectangles ($\mathbb{O}$) are attempted to be optimally placed in a larger rectangle ($O$) as shown in Fig
\ref{fig:packexample}. The rectangle packing problem is an NP-hard problem that can be used to describe many real life
problems \cite{Bruin2013,Murata1995}. In some of these problems, the dimensions of $\mathbb{O}$ are held constant such
as in the problem of packing modules on a chip, where the widths and height of the rectangles represent the physical
width and heights of the modules \cite{Murata1995}. Other problems, such as the BAP, in some formulations, allow one side of
the rectangle to vary depending on its assigned position (i.e. the handling time is dependent on the berth)
\cite{Buhrkal2010}.

The BAP solves the problem of optimally assigning incoming vessels to berth positions to be serviced (Fig
\ref{subfig:bapexample}). The width and height of $O$ represent the berth length $S$ and time horizon $T$, respectively.
Similarly, the width and height for $\mathbb{O}$ represent the time spent to service vessel $i$ and the space taken by
docking vessel $i$, respectively. The vessel characteristics (length of the vessel, arrival time, handling time, desired
departure time) are assumed to be known for all $N$ vessels to be serviced. A representation of a BAP solution is shown
in Fig \ref{fig:bap}.

The BAP objective is generally represented as minimizing some operational time for a given vessel $i$. The operational
time may be chosen to minimize the difference between arrival and departure times, time spent being serviced, or overall
waiting time \cite{Voss2007, Buhrkal2010,Frojan2015}. The model must then constrain the vessel placement as to not
allow overlap spatially or temporally.

\subsection{The PAP Formulation}
The BAP formulation forms the basis of the PAP; however, there are some differences in the way the variables are
perceived. For the $i^{th}$ visit, starting service time, $u_i$, is now the starting charge time, the berth location,
$v_i$, is now the charger queue for assignment, and the service time, $p_i$, is now the time to charge. The PAP utilizes
a number of parameters. The following parameters are constants.
\begin{itemize}
	\item $S$   : charger length
	\item $T$   : time horizon
	\item $N$   : number of incoming vehicles
	\item $p_i$ : charging time for vehicle $i;\; 1 \leq i \leq N$
	\item $s_i$ : width of vehicle $i;\; 1 \leq i \leq N$
	\item $a_i$ : arrival time of vehicle $i;\; 1 \leq i \leq N$
\end{itemize}

These constants define the problem bounds. The following list provides a series of decision variables used in the
formulation.

\begin{itemize}
    \item $u_i$    : starting time of service for vehicle $i;\; 1 \leq i \leq N$
    \item $v_i$    : charge location $i;\; 1 \leq i \leq N$
    \item $c_i$    : departure time for vehicle $i;\; 1 \leq i \leq N$
    \item $\sigma_{ij}$ : binary variable that determines ordering of vehicles $i$ and $j$ in time
    \item $\delta_{ij}$ : binary variable that determines relative position of vehicles $i$ and $j$ when charging simultaneously
\end{itemize}

To determine the values for each of these decision variables, a MILP is formulated in \cite{Qarebagh2019} and shown
here for sake of completeness.

\begin{equation}
	\label{eq:bapobjective}
	\min\; \sum_{i=1}^N (c_i - a_i)
\end{equation}
Subject to:
\begin{subequations}
\label{eq:bapconstrs}
\begin{align}
    u_j - u_i - p_i - (\sigma_{ij} - 1)T \geq 0                  \label{subeq:baptime}          \\
    v_j - v_i - s_i - (\delta_{ij} - 1)S \geq 0                  \label{subeq:bapspace}         \\
    \sigma_{ij} + \sigma_{ji} + \delta_{ij} + \delta_{ji} \geq 1 \label{subeq:bapvalid_pos}     \\
    \sigma_{ij} + \sigma_{ji} \leq 1                              \label{subeq:bapsigma}        \\
    \delta_{ij} + \delta_{ji} \leq 1                              \label{subeq:bapdelta}        \\
    p_i + u_i = c_i                                               \label{subeq:bapdetach}       \\
    a_i \leq u_i \leq (T - p_i)                                   \label{subeq:bapvalid_starts} \\
    \sigma_{ij} \in \{0,1\},\;\delta_{ij} \in \{0,1\}\;           \label{subeq:bapsdspace}      \\
    v_i \in [0 \mbox{ } S ]                                       \label{subeq:bapvspace}
\end{align}
\end{subequations}

\noindent

The objective function \eqref{eq:bapobjective} minimizes the time spent to service each vehicle by minimizing over the
sum of differences between the departure time, $c_i$, and arrival time, $a_i$. i.e., It seeks to get each vehicle
charged and on its way as quickly as possible.

Constraints \ref{subeq:baptime}-\ref{subeq:bapdelta} are used to ensure that individual rectangles do not overlap. For
the PAP, they ensure that two vehicles charging simultaneously are at different positions and, similarly, two vehicles
that have overlapping positions do not overlap temporally. Constraint \eqref{subeq:baptime} establishes temporal
ordering when active ($\sigma_{ij}=1$). Similarly, when $\delta_{ij} =1$ in \eqref{subeq:bapspace} then spatial ordering is
established. Constraints \ref{subeq:bapvalid_pos}-\ref{subeq:bapdelta} enforce that spatial and/or temporal ordering is
established between each possible vehicle pair. Constraints \eqref{subeq:bapsigma} and \eqref{subeq:bapdelta} enforce
consistency. For example, \eqref{subeq:bapsigma} enforces that vehicle $i$ cannot come before vehicle $j$ and vehicle
$j$ simultaneously come before vehicle $i$.

The last constraints force relationships between arrival time, charge start time, and departure time. Constraint
\eqref{subeq:bapdetach} states that the service start time, $u_i$, plus the time to service vehicle $i$, $p_i$, must
equal the departure time, $c_i$. Constraint \eqref{subeq:bapvalid_starts} enforces the arrival time, $a_i$, to be less
than or equal to the service start time, $u_i$, which in turn must be less than or equal to the latest time the vehicle
may begin to be serviced to stay within the time horizon. Constraint \eqref{subeq:bapsdspace} ensures that $\sigma_{ij}$ and
$\delta_{ij}$ are binary. Constraint \eqref{subeq:bapvspace} ensures that the assigned value of $v_i$ is a valid charging
position.

%%-------------------------------------------------------------------------------
%
\section{Problem Formulation}  \label{sec:problemformulation}
Applying the PAP to BEB charging requires four fundamental changes. The first is that the time that a BEB spends
charging is allowed to vary. Thus, $p_i$ becomes a variable of optimization. Second, in the PAP each charging visit is
assumed to be a different vehicle. For the BEB charging problem, each bus may make multiple visits to the station
throughout the day and the resulting charge for a bus at a given time is dependent upon each of the prior visits made.
Third, in the PAP, the charger is one continuous bar with vehicle width effectively restricting the number of vehicles
charging simultaneously. For the BEB, it is assumed that a specific number of chargers exist, and these chargers can
charge the vehicle at a different rate. The fourth fundamental change is related to the first three. The charge of each
bus must be tracked in the optimization to ensure that charging across multiple visits is sufficient to allow each bus
to execute its route throughout the day.

The discussion of the four changes are separated into two sections. Section \ref{sec:queuing} discusses the changes in
the spatial-temporal constraint formulation to form a queuing constraint. Section \ref{sec:batt_dynamics} then discusses
the addition of the bus charge management. This section ends with a brief discussion of a modified objective in Section
\ref{sec:objective-function} and the statement of the full problem in Section \ref{sec:BEB_MILP}. The notation is
explained throughout and summarized in Table \ref{tab:variables}.

\subsection{Queuing Constraints} \label{sec:queuing}
\noindent
The queuing constraints help to ensure that the busses enter queues for charging or waiting as they come into the
station. There are three sets to differentiate between different entities. $\mathbb{B} = \{1, ..., n_B\}$ is the set of
bus indices with index $b$ used to denote an individual bus, $\mathbb{Q} = \{1, ..., n_Q\}$ is the set of queues with index $q$
used to denote an individual queue, and $\mathbb{V} = \{1, ..., n_V\}$ is a set of visits to the station with $i,j$ used
to refer to individual visits. The mapping $\Gamma: \mathbb{V} \rightarrow \mathbb{B}$ is used to map a visit index to a bus index with
the shorthand $\Gamma_i$ used to refer to the bus index for visit $i$.

Most variables are now defined in terms of a visit. Two separate visits could correspond to different buses or visits by
the same bus. The spatial variable $s_i$ is removed and $v_i$ is made to be an integer corresponding to which queue
visit $i$ will be using. Thus, when $\delta_{ij} = 1$, the visits must be at different chargers, i.e., $v_i-v_j \geq 1$. The
variable $S$ is likewise replaced with $n_Q$. Note that $n_Q = n_B + n_C$, where $n_B$ is the number of busses and $n_C$
is the number of chargers. The rationale for having extra queues is to allow buses to sit idle instead of charging. The
modified queuing constraints can be written as follows.

\begin{subequations}
\label{eq:packconstrs}
\begin{align}
    u_i - u_j - p_j - (\sigma_{ij} - 1)T \geq 0   \label{subeq:time}         \\
    v_i - v_j - (\delta_{ij} - 1)n_Q \geq 1       \label{subeq:space}        \\
    \sigma_{ij} + \sigma_{ji} + \delta_{ij} + \delta_{ji} \geq 1 \label{subeq:valid_pos}    \\
    \sigma_{ij} + \sigma_{ji} \leq 1                   \label{subeq:sigma}        \\
    \delta_{ij} + \delta_{ji} \leq 1                   \label{subeq:delta}        \\
    p_i + u_i = c_i                       \label{subeq:detach}       \\
    a_i \leq u_i \leq (T - p_i)                 \label{subeq:valid_starts} \\
    c_i \leq \tau_i                             \label{subeq:valid_depart} \\
    p_i \geq 0                               \label{subeq:pos_charge} \\
    \sigma_{ij} \in \{0,1\},\;\delta_{ij} \in \{0,1\}   \label{subeq:sdspace}      \\
    v_i \in \mathbb{Q}                               \label{subeq:vspace}
\end{align}
\end{subequations}

Constraints \eqref{subeq:time}-\eqref{subeq:valid_starts} and \eqref{subeq:sdspace} are nearly identical to those
described in Section \ref{sec:positionallocationproblem} with the sole change in \eqref{subeq:space} being described
above to conform to a queue. Constraint \eqref{subeq:valid_depart} is added to ensure that the ending charge time,
$c_i$, must be less than or equal to the required departure time from the station, $\tau_i$. This enables the bus schedules
to be considered during optimization. Finally, \eqref{subeq:vspace} enforces $v_i$ to be an integer in the set of
possible queues.

\subsection{Battery Charge Dynamic Constraints}
\label{sec:batt_dynamics}
Using purely the constraints in \eqref{eq:packconstrs} with the objective in \eqref{eq:bapobjective} would result in
$c_i$ being chosen as small as possible by employing $p_i = 0,\; u_i = c_i$. Thus, the vehicles would not charge.
Furthermore, it does not encode any revisiting of the BEB to the charging station. To remedy this, battery dynamic
constraints are introduced.

Battery charge dynamic constraints are used to model the charge in each bus with the purpose of ensuring sufficient time
is spent charging. Two constraints are enforced on the bus charge: busses must always have sufficient charge to execute
their respective routes and each bus must end the day with a specific charge threshold, preparatory to execution for the
next day.

The charge at the beginning of visit $i$ is denoted as $\eta_i$. As a charge on the bus is dependent upon the visits that
bus makes to the station, the mapping $\Upsilon: \mathbb{V} \rightarrow \mathbb{V} \bigcup \{\varnothing\}$ is used to determine the next visit
that corresponds to the same bus, with $\Upsilon_i$ being shorthand notation. Thus, $\Gamma_i$ and $\Gamma_{\Upsilon_i}$ would both map to the
same bus index as long as $\Upsilon_i$ is not the null element, $\varnothing$. The null element is used to denote that there
are no future visits by that same bus.

To drive time spent on the charger, $p_i$, as well as define initial, final, and intermediate bus charges for each visit
$i$, the sets for initial and final visits must be defined. Let the mapping of the first visit by each bus be denoted as
$\Gamma^0_i : \mathbb{V} \rightarrow \mathbb{V} \bigcup \{\varnothing \}$. The indexed value of $\Gamma^0_i$ represents the index for the first
visit of bus $b$ or the null element, $\varnothing$. Similarly, let $\Gamma^f_i : \mathbb{V} \rightarrow \mathbb{V} \bigcup \{\varnothing \}$
contain the indexes for the final visit of each bus $b$ or the null element. The initial and final bus charges can then
be represented by the constraint equations $\eta_{\Gamma^0_i} = \alpha \kappa_{\Gamma^0_i}$ and \(\eta_{\Gamma^f_i} = \beta \kappa_{\Gamma^f_i}\), respectively,
where $\alpha$ and $\beta$ are percentages of the battery for first and final visit, respectively. The intermediate charges must
be determined at solve time.

It is assumed that the charge received is proportional to the time spent charging. The charge rate for charger $q$ is
denoted as $r_q$. Note that a value of $r_q = 0$ corresponds to a queue where no charging occurs. A bus in such a queue
is simply waiting for the departure time. Thus, $n_Q = n_C + n_B$ where the final $n_B$ queues have $r_q = 0$ to allow
an arbitrary number of buses to not charge at any given moment in time. The amount of discharge between visits $i$ and
$\Upsilon_i$, the next visit of the same bus, is denoted as $\lambda_i$. If visit $i$ occurred at charger $q$, the charge of the bus
coming into visit $\Upsilon_i$ would be

\begin{equation}
	\eta_{\Upsilon_i} = \eta_i + p_i r_q - \lambda_i.
\end{equation}

The binary decision variable $w_{iq}$ is introduced to determine whether visit $i$ uses charger $q$. This allows the
charge of the bus coming into visit $\Upsilon_i$ to be written in summation form as

\begin{subequations}
    \label{subeq:pre_next_charge}
\begin{align}
    \eta_{\Upsilon_i} = \eta_i + \sum_{q=1}^{n_Q} p_i w_{iq} r_q - \lambda_i  \\
    \sum_{q=1}^{n_Q} w_{iq} = 1 \\
    w_{iq} \in \{0,1\}
\end{align}
\end{subequations}

The choice of queue for visit $i$, $v_i$, becomes a slack variable and is defined in terms of $w_{iq}$ as

\begin{equation}
    v_i = \sum_{q=1}^{n_Q} qw_{iq}
\end{equation}

Maximum and minimum values for the charges are included to ensure the battery is not overcharged and to guarantee
sufficient charge for subsequent visits. The upper and lower battery charge bounds for bus $b$ are $\kappa_b$ and $\nu_b$,
respectively. As $\eta_i$ corresponds to the charge at the beginning of the visit, the upper bound constraint must also
include the charge received during the visit as follows.

\begin{subequations}
    \label{subeq:pre_min_max}
\begin{align}
    \eta_i + \sum_{q=1}^{n_Q} p_i w_{iq} r_q \leq \kappa_{\Gamma_i}                 \\
    \eta_i \geq \nu_{\Gamma_i} \kappa_{\Gamma_i}
\end{align}
\end{subequations}

Note that the term $p_i w_{iq}$ is a bilinear term (two decision variables being multiplied together) which is nonlinear
\cite{Rodriguez2013}. A standard way of linearizing a bilinear term that contains an integer variable is by introducing
a slack variable with an either/or constraint \cite{Chen2010,Rodriguez2013}. Allowing the slack variable $g_{iq}$ to be
equal to $p_i w_{iq}$, $g_{iq}$ can be defined as

\begin{equation}
    \label{eq:giq_cases}
    g_{iq} =
    \begin{cases}
        p_i & w_{iq} = 1 \\
        0 & w_{iq} = 0
    \end{cases}.
\end{equation}

Equation \eqref{eq:giq_cases} can be expressed as a mixed integer constraint using big-M notation with the following
four constraints.

\begin{subequations}
    \label{eq:slack_gain}
\begin{align}
    p_i - (1 - w_{iq})M \leq g_{iq}  \label{subeq:repgpgret} \\
    p_i \geq g_{iq}                 \label{subeq:repgples} \\
    Mw_{iq} \geq g_{iq}              \label{subeq:repgwgret} \\
    0 \leq g_{iq}                   \label{subeq:repgwles}
\end{align}
\end{subequations}

\noindent
where $M$ is a large value. If $w_{iq} = 1$ then \eqref{subeq:repgpgret} and \eqref{subeq:repgples} become $p_i \leq
g_{iq}$ and $p_i \geq g_{iq}$, effectively stating $p_i = g_{iq}$ with \eqref{subeq:repgwgret} being inactive. If $w_{iq} =
0$, \eqref{subeq:repgpgret} is inactive and \eqref{subeq:repgwgret} and \eqref{subeq:repgwles} force $g_{iq} = 0$.

\subsection{The BEB Charging Problem} \label{sec:BEB_MILP}
The goal of the MILP is to utilize chargers as little as possible to reduce energy costs with the fast charging
penalized greater to reduce battery damage. Thus, an assignment cost $m_q$ and usage cost $\epsilon_q$ are associated with each
charger, $q$. The cost for both the assignment and utilization of slow chargers is less than that of the fast chargers.
The objective function has an assignment term, $w_{iq}m_q$, which is non-zero if charger $q$ is used for visit $i$.
Similarly, a usage term $g_{iq} \epsilon_q$ is non-zero only if charge is received for visit $i$ at charger $q$. The resulting
objective is defined in Eq \ref{eq:objective}. The assignment cost, $w_{iq}m_q$, and the usage cost, $g_{iq}\epsilon_q$, are
summed over each visit, $i$, and charger, $q$.

\begin{equation}
\label{eq:objective}
	\min \sum_{i=1}^N \sum_{q=1}^{n_Q} \Big( w_{iq} m_q + g_{iq} \epsilon_q \Big) \\
\end{equation}

Subject to the constraints in Eq \ref{eq:dynconstrs}.

% Overall constraint equations
\input{eq/dynconstrs.tex}

Constraints \eqref{subeq:m_time}-\eqref{subeq:m_valid_depart} are reiterations of the queuing constraints in
\eqref{eq:packconstrs}. Constraints \eqref{subeq:init_charge}-\eqref{subeq:final_charge} provide initialization and
terminal conditions as well as intermediate constraints to provide continuity in vehicle charges. Constraint
\eqref{subeq:init_charge} states the first arrival for each bus is initialized with a charge of $\alpha \kappa_{\Gamma^0_i}$.
Constraints \eqref{subeq:next_charge}, \eqref{subeq:min_charge}, and \eqref{subeq:max_charge} define the battery charge
dynamics using \eqref{subeq:pre_next_charge} and \eqref{subeq:pre_min_max} with the gain slack variables $g_{iq}$ used
in place of the bilinear term. Constraints \eqref{subeq:gpgret} through \eqref{subeq:gwles} define $g_{iq}$ using
\eqref{eq:slack_gain}.

Constraint \eqref{subeq:max_charge} ensures that the charging done for visit $i$ cannot be greater than the capacity of
the battery, $\kappa_{\Gamma_i}$. Constraint \eqref{subeq:final_charge} states that the last visit for each vehicle must have a
minimum charge of $\beta \kappa_{\Gamma^f_i}$, guaranteeing a minimum initial charge for the next working day. The last constraints
\eqref{subeq:wspace}-\eqref{subeq:qspace} define the sets of valid values for each variable.

%================================================================================
% Example
\section{Example}
\label{sec:example}

An example will now be presented to demonstrate the utility of the developed MILP charge scheduling techique. A
description of the scenario is first presented followed a description of an alternative heuristic based planning
strategy called Quin-Modified which is used as a comparison to the MILP PAP. Results are then presented for each of
planning strategies are presented, analyzed, and discussed.

\subsection{BEB Scenario}
The utilizes $A = \A$ buses with $N = \N$ visits to the station divided between the $A$ buses. Each bus has a \batsize
KWh battery that is required to stay above \mincharge charge (\fpeval{\batsize * \mincharge / 100} KWh) to maintain
battery health, and the bus is assumed to begin the working day with \fpeval{\acharge*100}\% charge (\fpeval{\acharge *
  \batsize} KWh). Additionally, each bus is required to end the day with a minimum charge of \fpeval{\bcharge * 100}\%
(\fpeval{\bcharge * \batsize} KWh). Each bus is assumed to discharge at a rate of 30 KWh every hour while on route. Note
that there are many factors that play a factor in the rate of discharge; however, for the sake of simplicity an average
rate is used. Planning is done over a 24-hour time horizon. $n_C = \fpeval{\fast + \slow}$ chargers are utilized where
\slow of the chargers are slow charging (\slows KWh) and \fast are fast charging (\fasts KWh).

To encourage the MILP PAP problem to utilize the fewest number of chargers, the value of $m_q$ in the objective
function, \eqref{eq:objective}, is $\forall q \in Q; m_q = 1000q$. The value of $\epsilon = 1$ for all chargers. This effectively means
that the effort to reduce time on every charger is the same.

Another heuristic-based optimization strategy, known as Quin-Modified, is also employed as a means of comparison with
the results of the MILP PAP. The Quin-Modified strategies is a based on the threshold strategy of \cite{Qin2016}. The
strategy has been modified slightly to accommodate the case of multiple charger types and without exhaustive search for
the best charger types. The heuristic is based on a set of rules that revolve around the charge of the bus. There are
three different thresholds, low (60\%), medium (75\%), and high (90\%). Buses below the low threshold is prioritized to
fast chargers then slow chargers. Buses between low and medium prioritize slow chargers first and utilize fast chargers
only if no slow are available. Buses above the medium threshold and below high will only be assigned to slow chargers.
Buses above the high threshold will not be charged. Once a bus has been assigned to a charger, it remains on the charger
for the duration of the time it is at the station or it reaches 90\% charge, whichever comes first.

The schedule is sampled from UTA \TODO{is it?} bus routing data that occurs over a 24-hour time period. The total number
of constraints resulted in 8750 continuous and 132500 integer/binary constraints. The optimization was performed using
the Gurobi MILP solver \cite{GurobiOptimization2021} on a machine running an AMD Ryzen 9 5900X 12- Processor (24 core)
at 4.95GHz. The solver was allowed to run for \timeran seconds and converged on the optimal result in \gurobisolvetime
seconds.

\subsection{Results}
The schedule generated by the Quin-Modified strategy and the MILP PAP is shown in Fig \ref{subfig:quin-schedule} and Fig
\ref{subfig:milp-schedule}, respectively. The x-axis represents the horizon in hours. The y-axis represents the assigned
charger. Points between zero and \fpeval{\slow - 1} are active times for slow chargers, and points between the range of
\fpeval{\slow - 1} and \fpeval{\fast + \slow - 1} are active times for fast chargers. The hollow circle represents the
staring charge time for bus $b$ and the line to the vertical tick signifies the region of time the charger is active.
Each color in Fig \ref{subfig:quin-schedule} and \ref{subfig:milp-schedule} are used to identify the bus assigned.

\TODO{Compare schedules}

Fig \ref{subfig:quin-charge} and \ref{subfig:milp-charge} depicts the charge for every bus over the time horizon. Every
vehicle begins at 90\% charge, finishes at 70\% charge in the MILP PAP schedule, and never goes below \mincharge in the
intermediate arrivals as stated in the constraints \eqref{eq:dynconstrs}. There is no guarantee for this in the
Quin-Modified strategy. Fig \ref{fig:usage} represents the usage of each charger over the time horizon. The maximum
amount of slow chargers used at any given time is three and only one fast charger is utilized at a time.

The pattern, for the most part, in Fig \ref{fig:schedule} is to populate the first charger and supply the other chargers
as needed. Where this pattern primarily breaks down is around hour 15. Having moved each bus one charger down would have
resulted in the same cost. This behavior is due to a lack of cost for the amount of total chargers being utilized.
Adding a cost in the objective function to minimize the total amount of unique chargers would resolve this problem by
effectively attempting to ``pack'' the chargers down reducing the peak of Fig \ref{fig:usage}.

Although this formulation effectively discourages the use of fast chargers to utilize the more cost-effective slow
charges more readily, there is no consideration for the cost consumption and demand cost. Consumption cost accounts for
peak use of power in the system and demand cost accounts for the total energy used. These metrics are used to calculate
the monetary cost of the system. Calculating the demand cost would create more bilinear terms as the objective function
would have to sum over $\sum_{i=1}^N \sum_{q=1}^{n_Q} w_{iq}{r_q}(p_i)$, creating yet another linearization term. Furthermore,
the demand cost would require discretization of the system. The demand utilizes the peak energy consumption over 15
minute intervals and uses the largest peak as the rate to charge. This would require tracking of when a charger is
active and including another variable to enable and disable $w_{iq}r_q$. This example displays the limitation of the
MILP solver as it adds effort and complexity to the system as a trade-off for calculating the optimal schedule. Other
metaheuristic solvers, such as simulated annealing (SA), would allow the problem to be solved without having to
linearize the system. \TODO{get the citation for this}

%%-------------------------------------------------------------------------------
% Conclusion
\section{Conclusion}
\label{sec:conclusion}
\TODO{Rewrite}

This work developed a MILP scheduling framework that optimally assigns slow and fast chargers to a BEB bus fleet
assuming a constant schedule. The BAP was introduced with an example formulation and was then compared to the PAP. The
PAP constructed on the BAP to allow the time spent on the charger, $p_i$, to be a decision variable. Because the
original PAP required service time, $p_i$, to be given, linear battery dynamics were introduced to drive charging times.
Additional constraints were also introduced to provide limits for the battery dynamics.

An example was presented that demonstrated the ability of the formulation to optimally select slow and fast chargers to
meet the requirements of the time schedule and the charge consumed during the bus routes. It was also observed that the
formulation was able to successfully create a charging schedule without creating conflicts (Fig \ref{fig:schedule}). The
charge for each bus was tracked in Fig \ref{fig:charges} and shows that the schedule maintained the charges between the
maximum charge, 100\%, and the minimum charge, 25\%.

Limitations were demonstrated in the lack of objective to limit the total amount of chargers utilized and to calculate
the demand and consumption costs. Further fields of interest are to utilize the formulation (Eq \eqref{eq:objective} and
\eqref{eq:dynconstrs}) with nonlinear battery dynamics, calculation and utilization of the demand and consumption cost
in the objective function, and utilizing this formulation in a metaheuristic solver.

%%================================================================================
% Bibliography
%\bibliographystyle{Frontiers-Harvard}
\bibliographystyle{plain}
\bibliography{main}

%%================================================================================
% Figures

\newpage
\section*{Figure Captions}

%%--------------------------------------------------------------------------------
% BAP and PAP comparison
\input{fig/bappap.tex}

%%--------------------------------------------------------------------------------
% Variable table
\input{fig/vartab.tex}

%%--------------------------------------------------------------------------------
% Berth spatio-temporal graph
\input{fig/berth-time-space.tex}

%%--------------------------------------------------------------------------------
% Spatial temporal graph representation
\input{fig/baprep.tex}

%%--------------------------------------------------------------------------------
%
\input{fig/overlap.tex}

%%--------------------------------------------------------------------------------
% Charge Schedule
\input{fig/schedule.tex}

%%--------------------------------------------------------------------------------
% Bus charges
\input{fig/charge.tex}

%%--------------------------------------------------------------------------------
% Charger usage count
\input{fig/charger-count.tex}

%%--------------------------------------------------------------------------------
% Power consumption
\input{fig/power.tex}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\end{document}
